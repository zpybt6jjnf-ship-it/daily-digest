name: Daily Digest

on:
  # Run daily at 6am Eastern (11:00 UTC)
  schedule:
    - cron: '0 11 * * *'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      skip_content_review:
        description: 'Skip content review step'
        required: false
        default: 'false'
        type: boolean
      skip_presentation_review:
        description: 'Skip presentation review step'
        required: false
        default: 'false'
        type: boolean
      skip_send:
        description: 'Skip sending email'
        required: false
        default: 'false'
        type: boolean

jobs:
  generate-review-send:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install anthropic python-dotenv requests

      - name: Run digest pipeline
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GMAIL_ADDRESS: ${{ secrets.GMAIL_ADDRESS }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
          RECIPIENT_EMAIL: ${{ secrets.RECIPIENT_EMAIL }}
        run: |
          cd scripts
          ARGS=""
          if [ "${{ inputs.skip_content_review }}" = "true" ]; then
            ARGS="$ARGS --skip-content-review"
          fi
          if [ "${{ inputs.skip_presentation_review }}" = "true" ]; then
            ARGS="$ARGS --skip-presentation-review"
          fi
          if [ "${{ inputs.skip_send }}" = "true" ]; then
            ARGS="$ARGS --skip-send"
          fi
          python run_pipeline.py $ARGS

      - name: Commit digest and logs to repo
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add digests/ logs/
          git diff --staged --quiet || git commit -m "Add digest for $(date +%Y-%m-%d)"
          git push
